<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Govee Control Center</title>
</head>

<body>
    <style>
        body {
            background-color: rgb(54, 54, 54);
            color: white;
            font-family: sans-serif;
        }

        .device-box {
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 10px;
        }

        .device-box h2 {
            margin-top: 0;
        }
        

        .on {
            background-color: rgb(217, 221, 0);
        }

        .off {
            background-color: black;
        }

        #devices-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
    </style>

    <h1>Govee Control Center</h1>
    <h2 id="title">Your Devices</h1>
    <div id="devices-container"></div>

    <script>
        function hexToRgb(hex) {
            // Remove the leading # if it exists
            hex = hex.replace(/^#/, '');

            // Parse the hex values to RGB
            const bigint = parseInt(hex, 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;

            return { r, g, b };
        }

        async function changeColor(device, selectedColor) {
            const response = await fetch('http://localhost:3000/device/color', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requestId: 'uuid',
                    payload: {
                        sku: device.sku,
                        device: device.device,
                        color: selectedColor,
                    },
                }),
            });

            const data = await response.json();
            return data.capability.value;
        }

        async function toggleDevice(device, state) {
            const response = await fetch('http://localhost:3000/device/toggle', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requestId: 'uuid',
                    payload: {
                        sku: device.sku,
                        device: device.device,
                        state: state,
                    },
                }),
            });

            const data = await response.json();
            return data.capability.value;
        }

        async function changeBrightness(device, brightness) {
            brightness = parseInt(brightness);
            const response = await fetch('http://localhost:3000/device/brightness', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requestId: 'uuid',
                    payload: {
                        sku: device.sku,
                        device: device.device,
                        brightness: brightness,
                    },
                }),
            });

            const data = await response.json();
            return data.capability.value;
        }

        async function fetchDeviceState(device) {
            const response = await fetch('http://localhost:3000/device/state', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requestId: 'uuid',
                    payload: {
                        sku: device.sku,
                        device: device.device,
                    },
                }),
            });

            const data = await response.json();
            return data;
        }

        async function fetchLightScenes(device) {
            const response = await fetch('http://localhost:3000/device/lightscenes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requestId: 'uuid',
                    payload: {
                        sku: device.sku,
                        device: device.device,
                    },
                }),
            });

            const data = await response.json();
            return data;
        }

        async function fetchDIYScenes(device) {
            const response = await fetch('http://localhost:3000/device/diyscenes', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requestId: 'uuid',
                    payload: {
                        sku: device.sku,
                        device: device.device,
                    },
                }),
            });

            const data = await response.json();
            return data;
        }

        async function changeLightScene(device, scene, type) {
            const response = await fetch('http://localhost:3000/device/dynamic-scene', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    requestId: 'uuid',
                    payload: {
                        sku: device.sku,
                        device: device.device,
                        scene: scene,
                        instance: type,
                    },
                }),
            });

            const data = await response.json();
            return data.capability.value;
        }

        async function displayDevices(data) {
            const devicesContainer = document.getElementById('devices-container');
            devicesContainer.innerHTML = '';
            let deviceCount = 0;

            for (const device of data) {
                const deviceBox = document.createElement('div');
                deviceBox.classList.add('device-box');

                // Fetch device state
                const status = await fetchDeviceState(device);
                const onOffCapability = status.payload.capabilities.find(capability => capability.type === 'devices.capabilities.on_off');
                const colorstatus = status.payload.capabilities.find(capability => capability.type === 'devices.capabilities.color_setting');
                const brightnessstatus = status.payload.capabilities.find(capability => capability.type === 'devices.capabilities.range');
                const containDynamicScene = status.payload.capabilities.find(capability => capability.type === 'devices.capabilities.dynamic_scene');

                let lightscenes = await fetchLightScenes(device);
                let diyscenes = await fetchDIYScenes(device);



                // Display device information
                deviceBox.innerHTML = `
                    <h2>${device.deviceName}</h2>
                `;
                const colorButton = document.createElement('input');
                if (onOffCapability) {
                    // Display toggle button
                    const toggleButton = document.createElement('button');
                    toggleButton.innerHTML = 'Toggle';
                    toggleButton.addEventListener('click', async () => {
                        const newOnOffCapability = await toggleDevice(device, onOffCapability.state.value === 1 ? 0 : 1);
                        if (colorstatus) {
                            if (newOnOffCapability === 1) {
                                let hex = colorstatus.state.value.toString(16);
                                while (hex.length < 6) {
                                    hex = '0' + hex;
                                }
                                const hexColor = '#' + hex;
                                colorButton.value = hexColor;
                                deviceBox.classList.add('on');
                                deviceBox.classList.remove('off');
                            } else {
                                deviceBox.classList.add('off');
                                deviceBox.classList.remove('on');
                            }
                        }
                        else {
                            if (newOnOffCapability === 1) {
                                deviceBox.classList.add('on');
                                deviceBox.classList.remove('off');
                            } else {
                                deviceBox.classList.add('off');
                                deviceBox.classList.remove('on');
                            }
                        }
                        onOffCapability.state.value = newOnOffCapability;
                    });
                    deviceBox.appendChild(toggleButton);
                }

                //Add a button to open the color picker to change the color of the device if it has the color capability 'devices.capabilities.color_setting'
                const colorCapability = device.capabilities.find(capability => capability.type === 'devices.capabilities.color_setting');

                if (colorCapability) {

                    colorButton.type = 'color';
                    colorButton.innerHTML = 'Change Color';
                    colorButton.addEventListener('input', async () => {


                        let selectedColor = colorButton.value;
                        let rgb = hexToRgb(selectedColor);
                        let rgbValue = ((rgb.r & 0xFF) << 16) | ((rgb.g & 0xFF) << 8) | (rgb.b & 0xFF);


                        const newColorCapability = await changeColor(device, rgbValue);
                        colorstatus.state.value = newColorCapability;
                        let hex = colorstatus.state.value.toString(16);
                        while (hex.length < 6) {
                            hex = '0' + hex;
                        }
                        const hexColor = '#' + hex;
                        if (onOffCapability.state.value === 1) {
                            colorButton.value = hexColor;
                            deviceBox.classList.add('on');
                            deviceBox.classList.remove('off');
                        } else {
                            deviceBox.classList.add('off');
                            deviceBox.classList.remove('on');
                        }
                    });
                    deviceBox.appendChild(colorButton);
                }

                if (colorstatus) {
                    let hex = colorstatus.state.value.toString(16);
                    while (hex.length < 6) {
                        hex = '0' + hex;
                    }
                    const hexColor = '#' + hex;

                    if (onOffCapability.state.value === 1) {
                        colorButton.value = hexColor;
                        deviceBox.classList.add('on');
                        deviceBox.classList.remove('off');

                    } else {
                        colorButton.value = hexColor;
                        deviceBox.classList.add('off');
                        deviceBox.classList.remove('on');
                    }
                }
                else {
                    // Update deviceBox color based on state
                    if (onOffCapability && onOffCapability.state.value === 1) {
                        deviceBox.classList.add('on');
                    } else {
                        deviceBox.classList.add('off');
                    }
                }



                //add a brightness slider if the device has the brightness capability 'devices.capabilities.range'
                const brightnessCapability = device.capabilities.find(capability => capability.type === 'devices.capabilities.range');
                if (brightnessCapability) {
                    const brightnessSlider = document.createElement('input');
                    brightnessSlider.type = 'range';
                    brightnessSlider.min = 1;
                    brightnessSlider.max = 100;
                    brightnessSlider.step = 1;
                    brightnessSlider.value = brightnessstatus.state.value;
                    brightnessSlider.addEventListener('mouseup', async () => {
                        const newBrightnessCapability = await changeBrightness(device, brightnessSlider.value);
                    });
                    deviceBox.appendChild(brightnessSlider);
                }

                let scenes = [];
                let lightscenespresent = false;
                scenes = diyscenes.payload.capabilities.find(capability => capability.type === 'devices.capabilities.diy_color_setting').parameters.options;

                //i want to chack if the device has the field parameters in the lightscenes payload inside the capabilities array scene_color_setting becasuse when the device dont have light scenes there is not just a blank array in parameters.option but the field parameters is not there at all

                if (lightscenes.payload.capabilities.find(capability => capability.type === 'devices.capabilities.scene_color_setting').parameters !== undefined) {
                    lightscenes = lightscenes.payload.capabilities.find(capability => capability.type === 'devices.capabilities.scene_color_setting').parameters.options;
                    diyscenes = diyscenes.payload.capabilities.find(capability => capability.type === 'devices.capabilities.diy_color_setting').parameters.options;
                    scenes = lightscenes.concat(diyscenes);
                    lightscenespresent = true;
                }




                if (scenes.length !== 0) {



                    //if the device has the capability 'devices.capabilities.dynamic_scene' add a button to change the light scene

                    if (containDynamicScene) {
                        const dynamicSceneButton = document.createElement('select');


                        //add a default option labeled 'Select a scene' to the dropdown and ignore it if it is selected
                        const defaultOption = document.createElement('option');
                        defaultOption.value = 'default';
                        defaultOption.innerHTML = 'Select a scene';
                        defaultOption.selected = true;
                        dynamicSceneButton.appendChild(defaultOption);


                        for (scene of scenes) {
                            const option = document.createElement('option');
                            option.value = scene.value;
                            option.innerHTML = scene.name;
                            dynamicSceneButton.appendChild(option);
                        }
                        dynamicSceneButton.addEventListener('change', async () => {
                            //we want to know if the scene is a light scene or a diy scene but the only way to know is to check if the scene is in the lightscenes array or the diyscenes array
                            if (dynamicSceneButton.value === 'default') {
                                return;
                            }
                            let scenevalue = parseInt(dynamicSceneButton.value);
                            let type = 'lightScene';
                            if (lightscenespresent) {
                                if (lightscenes.find(scene => scene.value === scenevalue) === undefined) {
                                    type = 'diyScene';
                                }
                            }
                            else {
                                type = 'diyScene';
                            }
                            const response = await changeLightScene(device, scenevalue, type);
                        });
                        deviceBox.appendChild(dynamicSceneButton);
                    }
                }

                devicesContainer.appendChild(deviceBox);
                deviceCount++;
            }
            document.getElementById('title').innerHTML = `Your Devices (${deviceCount})`;
        }

        // Fetch devices from Govee API
        fetch('http://localhost:3000/devices')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                // Display devices on the webpage
                displayDevices(data);
            })
            .catch(error => {
                console.error('Error fetching devices:', error);
            });
    </script>
</body>

</html>
